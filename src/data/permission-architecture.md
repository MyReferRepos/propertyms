# 权限管理架构设计

## 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        RBAC 权限管理系统                          │
└─────────────────────────────────────────────────────────────────┘
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
                ▼                ▼                ▼
        ┌──────────┐     ┌──────────┐     ┌──────────┐
        │   用户    │────▶│   角色    │────▶│   权限    │
        │  (User)  │     │  (Role)  │     │(Permission)│
        └──────────┘     └──────────┘     └──────────┘
             │                │                │
             │                │                │
             └────────────────┴────────────────┘
                          User → Role → Permission
```

## 2. 权限分类体系

```
┌─────────────────────────────────────────────────────────────────┐
│                          Permission                              │
│                     (权限 - 最小粒度单元)                          │
└─────────────────────────────────────────────────────────────────┘
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
                ▼                ▼                ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │  菜单权限     │  │  API权限      │  │  按钮权限     │
        │ (MENU Type)  │  │ (API Type)   │  │(BUTTON Type) │
        └──────────────┘  └──────────────┘  └──────────────┘
        │                │                │
        │ 控制导航可见   │ 控制API访问    │ 控制功能按钮
        │                │                │
        │ users:menu    │ users:view     │ users:btn:export
        │ roles:menu    │ users:create   │ users:btn:import
        │ settings:menu │ users:update   │
        │                │ users:delete   │
        └────────────────┴────────────────┴────────────────┘
```

## 3. 模块权限详细结构 (以用户管理为例)

```
┌───────────────────────────────────────────────────────────────────┐
│                       用户管理模块 (Users)                          │
└───────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  菜单权限     │      │  API权限      │      │  按钮权限     │
│──────────────│      │──────────────│      │──────────────│
│ users:menu   │      │ users:view   │      │users:btn:    │
│              │      │ users:create │      │  export      │
│ 控制菜单可见  │      │ users:update │      │users:btn:    │
│              │      │ users:delete │      │  import      │
│              │      │              │      │users:btn:    │
│              │      │              │      │  batch-delete│
└──────────────┘      └──────────────┘      └──────────────┘
       │                     │                     │
       │ 前端路由守卫         │ API接口守卫          │ UI组件守卫
       ▼                     ▼                     ▼
   显示/隐藏菜单          允许/拒绝API调用       启用/禁用按钮
```

## 4. 权限数据结构

```typescript
// 权限实体
interface Permission {
  id: string              // 'perm-users-menu'
  name: string            // '用户管理菜单'
  code: string            // 'users:menu'
  type: PermissionType    // 'menu' | 'api' | 'button'
  module: string          // 'users'
  parentCode?: string     // 'users:menu' (可选关联)
  description?: string
}

// 权限类型
enum PermissionType {
  MENU = 'menu',         // 菜单/导航权限
  API = 'api',           // API操作权限
  BUTTON = 'button'      // 按钮/功能权限
}
```

## 5. 完整的权限示例 (用户管理模块)

```
users (用户管理模块)
│
├── [MENU] users:menu ──────────────┐
│   └─ 用户管理菜单                   │ (可选的父子关联)
│                                    │
├── [API] users:view ────────────────┤
│   └─ 查看用户列表                   │
│                                    │
├── [API] users:create ──────────────┤
│   └─ 创建新用户                     │
│                                    │
├── [API] users:update ──────────────┤
│   └─ 更新用户信息                   │
│                                    │
├── [API] users:delete ──────────────┤
│   └─ 删除用户                       │
│                                    │
└── [BUTTON] users:btn:export ───────┘
    └─ 导出用户数据
```

## 6. 权限分配流程

```
┌──────────┐
│ 创建角色  │
└────┬─────┘
     │
     ▼
┌──────────────────────────────┐
│  选择模块权限                 │
│  ┌────────────────────────┐ │
│  │ □ 用户管理              │ │
│  │   ├─ ☑ users:menu      │ │ ◄─── 菜单权限 (必选基础)
│  │   ├─ ☑ users:view      │ │ ◄─── API权限 (独立选择)
│  │   ├─ ☑ users:create    │ │
│  │   ├─ ☑ users:update    │ │
│  │   ├─ □ users:delete    │ │ ◄─── 可单独控制
│  │   └─ □ users:btn:export│ │
│  └────────────────────────┘ │
└──────────────────────────────┘
     │
     ▼
┌──────────┐
│ 分配用户  │
└────┬─────┘
     │
     ▼
┌──────────┐
│ 用户登录  │
└────┬─────┘
     │
     ▼
┌──────────────────────────────┐
│  权限校验                     │
│  ┌────────────────────────┐ │
│  │ 菜单渲染               │ │ ◄─── 检查 users:menu
│  │ 页面访问               │ │ ◄─── 检查 users:view
│  │ 创建按钮               │ │ ◄─── 检查 users:create
│  │ 编辑按钮               │ │ ◄─── 检查 users:update
│  │ 删除按钮 (禁用)        │ │ ◄─── 无 users:delete
│  └────────────────────────┘ │
└──────────────────────────────┘
```

## 7. 前后端权限校验架构

```
┌─────────────────────────────────────────────────────────────┐
│                         前端应用                             │
└─────────────────────────────────────────────────────────────┘
                              │
    ┌─────────────────────────┼─────────────────────────┐
    │                         │                         │
    ▼                         ▼                         ▼
┌─────────┐             ┌─────────┐             ┌─────────┐
│ 路由守卫 │             │ 菜单渲染 │             │ 组件守卫 │
│─────────│             │─────────│             │─────────│
│ 检查    │             │ 检查    │             │ 检查    │
│ view权限│             │ menu权限│             │ 具体权限│
└────┬────┘             └────┬────┘             └────┬────┘
     │                       │                       │
     │  hasPermission('users:view')                  │
     │  hasPermission('users:menu')                  │
     │  hasPermission('users:create')                │
     │                       │                       │
     └───────────────────────┴───────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │  Permission Store  │
                    │  (Zustand/Redux)   │
                    └─────────┬─────────┘
                              │
                    ┌─────────▼─────────┐
                    │   JWT Token       │
                    │ {                 │
                    │   permissions: [  │
                    │     'users:menu', │
                    │     'users:view', │
                    │     ...           │
                    │   ]               │
                    │ }                 │
                    └─────────┬─────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      HTTP Request                            │
│                  Authorization: Bearer <token>               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         后端API                              │
└─────────────────────────────────────────────────────────────┘
                              │
    ┌─────────────────────────┼─────────────────────────┐
    │                         │                         │
    ▼                         ▼                         ▼
┌─────────┐             ┌─────────┐             ┌─────────┐
│ JWT验证 │             │权限验证  │             │数据访问  │
│─────────│────────────▶│─────────│────────────▶│─────────│
│ 解析Token│             │ 检查权限 │             │ 执行操作 │
│         │             │@Require  │             │         │
│         │             │Permission│             │         │
└─────────┘             └─────────┘             └─────────┘
                              │
                              │
                    ┌─────────▼─────────┐
                    │  Permission Guard │
                    │                   │
                    │ @RequirePermission│
                    │ ('users:create')  │
                    │                   │
                    │ if (!has) {       │
                    │   throw 403       │
                    │ }                 │
                    └───────────────────┘
```

## 8. 数据库表结构设计

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   users     │         │   roles     │         │ permissions │
├─────────────┤         ├─────────────┤         ├─────────────┤
│ id (PK)     │         │ id (PK)     │         │ id (PK)     │
│ username    │         │ name        │         │ name        │
│ email       │         │ code        │         │ code        │
│ password    │         │ description │         │ type        │◄── NEW
│ ...         │         │ is_system   │         │ module      │
└──────┬──────┘         └──────┬──────┘         │ parent_code │◄── NEW
       │                       │                 │ description │
       │                       │                 └──────┬──────┘
       │                       │                        │
       ▼                       ▼                        │
┌─────────────────┐    ┌──────────────────┐           │
│ user_roles      │    │ role_permissions │           │
├─────────────────┤    ├──────────────────┤           │
│ user_id (FK)    │    │ role_id (FK)     │           │
│ role_id (FK)    │    │ permission_id(FK)│───────────┘
└─────────────────┘    └──────────────────┘

关系说明:
- User : Role = N : M (多对多)
- Role : Permission = N : M (多对多)
- User → Role → Permission (间接获取)
```

## 9. 权限命名规范总结

```
┌──────────────────────────────────────────────────────┐
│                   权限命名规范                         │
├──────────────────────────────────────────────────────┤
│                                                      │
│  菜单权限:    {module}:menu                          │
│              例: users:menu, roles:menu             │
│                                                      │
│  API权限:     {module}:{action}                     │
│              例: users:view, users:create           │
│                                                      │
│  按钮权限:    {module}:btn:{action}                 │
│              例: users:btn:export                   │
│                                                      │
│  特殊权限:    {module}:{special}                    │
│              例: users:change-password              │
│                                                      │
└──────────────────────────────────────────────────────┘

推荐的Action命名:
┌─────────────┬──────────────────────────────┐
│   Action    │           说明               │
├─────────────┼──────────────────────────────┤
│ view        │ 查看列表/访问页面             │
│ create      │ 创建新记录                   │
│ read        │ 查看详情                     │
│ update      │ 更新记录                     │
│ delete      │ 删除记录                     │
│ batch-delete│ 批量删除                     │
│ export      │ 导出数据                     │
│ import      │ 导入数据                     │
│ approve     │ 审批操作                     │
└─────────────┴──────────────────────────────┘
```

## 10. 实施优先级

```
第一阶段: 基础架构
├─ ✅ 扩展Permission类型定义 (type, parentCode)
├─ ✅ 更新Mock数据
└─ ✅ 调整权限管理UI显示

第二阶段: 权限分配
├─ ✅ 优化角色编辑界面 (分组展示)
├─ ✅ 实现权限树形选择
└─ ✅ 添加权限依赖校验

第三阶段: 权限校验
├─ ✅ 实现菜单权限校验
├─ ✅ 实现路由权限守卫
├─ ✅ 实现按钮/组件权限控制
└─ ✅ 后端API权限验证

第四阶段: 优化完善
├─ ✅ 权限缓存优化
├─ ✅ 权限变更实时更新
└─ ✅ 权限审计日志
```
